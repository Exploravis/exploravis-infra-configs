on:
  push:
    branches:
    - main
  workflow_dispatch:
jobs:
  demo:
    permissions:
      id-token: write
      contents: read
    name: teleport
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Fetch Teleport binaries
      uses: teleport-actions/setup@v1
      with:
        version: auto
        proxy: teleport.exploravis.mywire.org:443

    - name: Fetch credentials using Machine ID
      id: auth
      uses: teleport-actions/auth@v2
      with:
        proxy: teleport.exploravis.mywire.org:443 
        token: github-actions-token 
        credential-ttl: 1h
        anonymous-telemetry: 1

    - name: Connect to the default kubernetes cluster 
      run: tsh kube login default 

    - name: Bootstrap ArgoCD 
      run: tsh kubectl apply -f argocd/bootstrap/ --validate=false

    - name: Add ArgoCD app to Teleport  
      run: tctl create -f argocd/teleport/argo-cd-teleport-app.yaml
